---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

// ── GitHub Activity (build-time) ──
const GITHUB_USER = 'omid3098';
const fallbackActivities = [
  { text: 'Started <strong>OpenShaderGraph</strong> — a node-based shader language that doesn\'t care which engine you\'re using.' },
  { text: 'Pushed updates to <strong>OpenFlowMap</strong> — refactored the flow algorithm and rewrote the docs. <span class="stars">118 ★</span>' },
  { text: '<strong>Glass Shader</strong> crossed 270 stars — a simple shader I made because Unity\'s default glass looked terrible.' },
  { text: 'Wrote a script to automate <strong>paqet</strong> server setup — turned a long manual process into one command.' },
];

function mapGitHubEvent(event: any) {
  const repo = event.repo?.name?.split('/')[1] || event.repo?.name || '';

  switch (event.type) {
    case 'PushEvent': {
      const commits = event.payload?.commits || [];
      const msg = commits[0]?.message?.split('\n')[0] || 'new changes';
      return { text: `Pushed to <strong>${repo}</strong> — ${msg}` };
    }
    case 'CreateEvent': {
      const ref = event.payload?.ref_type || 'repository';
      const name = event.payload?.ref;
      const label = name ? `${ref} <strong>${name}</strong> in <strong>${repo}</strong>` : `<strong>${repo}</strong>`;
      return { text: `Created ${label}` };
    }
    case 'WatchEvent':
      return { text: `Starred <strong>${repo}</strong>` };
    case 'ForkEvent': {
      const forkee = event.payload?.forkee?.full_name || repo;
      return { text: `Forked <strong>${forkee}</strong>` };
    }
    case 'ReleaseEvent': {
      const tag = event.payload?.release?.tag_name || '';
      return { text: `Released <strong>${tag}</strong> of <strong>${repo}</strong>` };
    }
    case 'IssuesEvent': {
      const action = event.payload?.action || 'opened';
      const title = event.payload?.issue?.title || '';
      return { text: `${action.charAt(0).toUpperCase() + action.slice(1)} issue on <strong>${repo}</strong>${title ? ` — ${title}` : ''}` };
    }
    case 'PullRequestEvent': {
      const action = event.payload?.action || 'opened';
      const title = event.payload?.pull_request?.title || '';
      return { text: `${action.charAt(0).toUpperCase() + action.slice(1)} PR on <strong>${repo}</strong>${title ? ` — ${title}` : ''}` };
    }
    default:
      return null;
  }
}

let activities = fallbackActivities;
try {
  const res = await fetch(`https://api.github.com/users/${GITHUB_USER}/events/public`);
  if (res.ok) {
    const events = await res.json();
    const mapped = events.map(mapGitHubEvent).filter(Boolean);
    const seen = new Set();
    const unique = mapped.filter((a: any) => {
      const key = a.text;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
    if (unique.length >= 3) {
      activities = unique.slice(0, 6);
    }
  }
} catch (e) {
  // Fallback to hardcoded activities
}

// ── Blog posts (content list) ──
const posts = await getCollection('blog', ({ data }) => !data.draft);

const sortedItems = posts
  .map((post) => ({
    tag: post.data.tags?.[0] || 'post',
    title: post.data.title,
    description: post.data.description || '',
    meta: post.data.meta || String(post.data.date.getFullYear()),
    image: post.data.image || '',
    order: post.data.order || 0,
    date: post.data.date,
    href: `/writing/${post.id}`,
  }))
  .sort((a, b) => b.order - a.order || b.date.getTime() - a.date.getTime());

const featured = sortedItems[0];
const rest = sortedItems.slice(1);
---

<Base>
  <div class="greeting fade-in">
    <p>
      If something feels too complicated, I'll <em>probably do something about it.</em>
      In games, that meant building tools so artists could focus on art instead of
      debugging broken assets. Last week it meant writing a script that turns a
      30-minute server setup into one command. The context changes, the instinct doesn't.
    </p>
  </div>

  <section class="these-days fade-in">
    <div class="section-label">these days</div>
    <div class="activity-list">
      {activities.map((activity) => (
        <div class="activity-item">
          <div class="activity-dot"></div>
          <div class="activity-text" set:html={activity.text} />
        </div>
      ))}
    </div>
    <div class="activity-source">From <a href="https://github.com/omid3098" target="_blank">github.com/omid3098</a></div>
  </section>

  <section class="content-section fade-in">
    <div class="section-label">work & writing</div>
    <div class="content-list">
      {featured && (
        <a class="content-item featured" href={featured.href}>
          {featured.image && <div class="item-bg" style={`background-image: url('${featured.image}');`}></div>}
          <div class="item-left">
            <span class="item-tag">{featured.tag}</span>
            <span class="item-title" transition:name={`title-${featured.href.split('/').pop()}`}>{featured.title}</span>
          </div>
          <div class="item-meta">{featured.meta}</div>
          {featured.description && <div class="featured-desc">{featured.description}</div>}
        </a>
      )}

      {rest.map((item) => (
        <a class="content-item" href={item.href}>
          {item.image && <div class="item-bg" style={`background-image: url('${item.image}');`}></div>}
          <div class="item-left">
            <span class="item-tag">{item.tag}</span>
            <span class="item-title" transition:name={`title-${item.href.split('/').pop()}`}>{item.title}</span>
          </div>
          <div class="item-meta">{item.meta}</div>
        </a>
      ))}
    </div>
    <a href="/writing" class="see-more">See all work & writing <span class="arrow">&rarr;</span></a>
  </section>
</Base>
