---
import Base from '../layouts/Base.astro';
import { getSortedPosts } from '../lib/posts';

// ── GitHub Activity (build-time) ──
const GITHUB_USER = 'omid3098';
const ghUrl = (repo: string) => `https://github.com/${GITHUB_USER}/${repo}`;

// Curated narratives for known repos — the "story" behind each project.
// When GitHub shows activity on one of these, we surface the story, not the commit.
const repoNarratives: Record<string, string> = {
  'OpenShaderGraph': 'Working on <strong>OpenShaderGraph</strong> — a shader language that doesn\'t care which engine you\'re using.',
  'open-flowmap': 'Refining <strong>Open Flowmap</strong> — a GPU-based flowmap painter for Unity. <span class="stars">118 ★</span>',
  'GlassShader': 'Maintaining <strong>Glass Shader</strong> — a realistic glass material I made because Unity\'s default looked terrible. <span class="stars">270 ★</span>',
  'quran_reader': 'Building <strong>QuranReader</strong> — a personal tool for studying the Quran.',
  'conduit_expose': 'Improving <strong>Conduit Expose</strong> — making local dev servers reachable from anywhere.',
  'conduit_monitor': 'Working on <strong>Conduit Monitor</strong> — a lightweight uptime checker for my own services.',
};

// Repos that are just infra noise — skip entirely
const ignoredRepos = new Set([
  'omid3098.github.io',
  'sveltia-cms-auth',
  'omid-saadat-new',
]);

const fallbackActivities = [
  { text: repoNarratives['OpenShaderGraph'], url: ghUrl('OpenShaderGraph') },
  { text: repoNarratives['open-flowmap'], url: ghUrl('open-flowmap') },
  { text: repoNarratives['GlassShader'], url: ghUrl('GlassShader') },
  { text: repoNarratives['quran_reader'], url: ghUrl('quran_reader') },
];

let activities = fallbackActivities;
try {
  const res = await fetch(`https://api.github.com/users/${GITHUB_USER}/events/public`);
  if (res.ok) {
    const events = await res.json();
    // Find which repos have recent activity, in order
    const activeRepos: string[] = [];
    const seen = new Set<string>();
    for (const event of events) {
      const repo = event.repo?.name?.split('/')[1] || '';
      if (!repo || seen.has(repo) || ignoredRepos.has(repo)) continue;
      seen.add(repo);
      activeRepos.push(repo);
    }
    // Build narrative list: curated stories for known repos, warm fallback for others
    const narratives = activeRepos
      .map((repo) => {
        const url = ghUrl(repo);
        if (repoNarratives[repo]) return { text: repoNarratives[repo], url };
        const name = repo.replace(/[-_]/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        return { text: `Spending some time on <strong>${name}</strong>.`, url };
      });
    if (narratives.length >= 3) {
      activities = narratives.slice(0, 6);
    }
  }
} catch (e) {
  // Fallback to curated activities
}

// ── Blog posts (content list) ──
const optimizedItems = await getSortedPosts();
const featured = optimizedItems[0];
const rest = optimizedItems.slice(1);
---

<Base>
  <h1 class="sr-only">Omid Saadat — Technical Artist</h1>
  <div class="greeting fade-in">
    <p>
      If something feels too complicated, I'll <em>probably do something about it.</em>
      In games, that meant building tools so artists could focus on art instead of
      debugging broken assets. Outside of games, it might mean writing a script that turns a
      30-minute server setup into one command. The context changes, the instinct doesn't.
    </p>
  </div>

  <section class="these-days fade-in">
    <div class="section-header">
      <h2 class="section-label">what i'm working on these days</h2>
      <div class="activity-source">From <a href="https://github.com/omid3098" target="_blank" rel="noopener noreferrer">github.com/omid3098</a></div>
    </div>
    <div class="activity-list">
      {activities.map((activity) => (
        <a class="activity-item" href={activity.url} target="_blank" rel="noopener noreferrer">
          <div class="activity-dot"></div>
          <div class="activity-text" set:html={activity.text} />
        </a>
      ))}
    </div>
  </section>

  <section class="content-section fade-in">
    <h2 class="section-label">work & writing</h2>
    <div class="content-list">
      {featured && (
        <a class="content-item featured" href={featured.href}>
          {featured.image && <div class="item-bg" style={`background-image: url('${featured.image}');`}></div>}
          <div class="item-left">
            <span class="item-tag">{featured.tag}</span>
            <span class="item-title" transition:name={`title-${featured.href.split('/').pop()}`}>{featured.title}</span>
          </div>
          <div class="item-meta">{featured.meta}</div>
          {featured.description && <div class="featured-desc">{featured.description}</div>}
        </a>
      )}

      {rest.map((item) => (
        <a class="content-item" href={item.href}>
          {item.image && <div class="item-bg" data-bg={item.image}></div>}
          <div class="item-left">
            <span class="item-tag">{item.tag}</span>
            <span class="item-title" transition:name={`title-${item.href.split('/').pop()}`}>{item.title}</span>
          </div>
          <div class="item-meta">{item.meta}</div>
        </a>
      ))}
    </div>
    <a href="/writing" class="see-more">See all work & writing <span class="arrow">&rarr;</span></a>
  </section>
</Base>
