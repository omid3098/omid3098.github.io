---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';

const posts = await getCollection('blog', ({ data }) => !data.draft);

const sortedItems = posts
  .map((post) => ({
    tag: post.data.tags?.[0] || 'post',
    title: post.data.title,
    description: post.data.description || '',
    meta: post.data.meta || String(post.data.date.getFullYear()),
    image: post.data.image || '',
    order: post.data.order || 0,
    date: post.data.date,
    href: `/writing/${post.id}`,
  }))
  .sort((a, b) => {
    const aPinned = a.order > 0 ? 1 : 0;
    const bPinned = b.order > 0 ? 1 : 0;
    if (aPinned !== bPinned) return bPinned - aPinned;
    if (aPinned && bPinned) return b.order - a.order;
    return b.date.getTime() - a.date.getTime();
  });

// ── Optimize card images ──
const imageImports = import.meta.glob<{ default: ImageMetadata }>(
  '../../public/assets/img/**/*.{png,jpg,jpeg}'
);

async function resolveImage(imagePath: string) {
  if (!imagePath || imagePath.endsWith('.gif')) return imagePath;
  const srcPath = imagePath.replace('/assets/img/', '../../public/assets/img/');
  const loader = imageImports[srcPath];
  if (!loader) return imagePath;
  const mod = await loader();
  const optimized = await getImage({ src: mod.default, width: 800, format: 'webp' });
  return optimized.src;
}

const optimizedItems = await Promise.all(
  sortedItems.map(async (item) => ({
    ...item,
    image: await resolveImage(item.image),
  }))
);
---

<Base title="Writing" description="Ideas, guides, and project write-ups." activePage="writing">
  <div class="page-header">
    <h1 class="page-title">Writing</h1>
    <p class="page-description">Ideas, guides, and project write-ups.</p>
  </div>

  <div class="content-list">
    {optimizedItems.map((item, i) => (
      <a class={`content-item${i === 0 ? ' featured' : ''}`} href={item.href}>
        {item.image && <div class="item-bg" {...(i === 0 ? { style: `background-image: url('${item.image}');` } : { 'data-bg': item.image })}></div>}
        <div class="item-left">
          <span class="item-tag">{item.tag}</span>
          <span class="item-title" transition:name={`title-${item.href.split('/').pop()}`}>{item.title}</span>
        </div>
        <div class="item-meta">{item.meta}</div>
        {i === 0 && item.description && <div class="featured-desc">{item.description}</div>}
      </a>
    ))}
  </div>
</Base>
