---
import Base from './Base.astro';

interface Props {
  frontmatter: {
    title: string;
    date: Date;
    tags?: string[];
    lang?: string;
    dir?: string;
    mermaid?: boolean;
  };
  slug?: string;
}

const { frontmatter, slug } = Astro.props;
const lang = frontmatter.lang || 'en';
const dir = frontmatter.dir || 'ltr';
const dateStr = frontmatter.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Base title={frontmatter.title} lang={lang} dir={dir} activePage="writing">
  <article class={dir === 'rtl' ? 'rtl' : ''}>
    <header class="page-header">
      <h1 class="page-title" transition:name={slug ? `title-${slug}` : undefined}>{frontmatter.title}</h1>
      <div class="post-meta">
        <time>{dateStr}</time>
        {frontmatter.tags && frontmatter.tags.length > 0 && (
          <span class="post-tags">
            {frontmatter.tags.slice(0, 4).map(tag => (
              <span class="tag">{tag}</span>
            ))}
          </span>
        )}
      </div>
    </header>
    <div class="prose">
      <slot />
    </div>
  </article>

  {frontmatter.mermaid && (
    <script is:inline type="module" data-astro-rerun>
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
      // Astro/Shiki renders ```mermaid blocks as:
      //   <pre class="astro-code" data-language="mermaid"><code><span>...</span></code></pre>
      // Mermaid expects <pre class="mermaid"> with raw text â€” convert before init.
      document.querySelectorAll('pre[data-language="mermaid"]').forEach((pre) => {
        const code = pre.querySelector('code');
        if (code) {
          const text = code.textContent;
          pre.className = 'mermaid';
          pre.removeAttribute('style');
          pre.removeAttribute('data-language');
          pre.textContent = text;
        }
      });
      mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
          primaryColor: '#232328',
          primaryTextColor: '#d2d2d2',
          primaryBorderColor: '#6cb4ee',
          lineColor: '#5a5a5a',
          secondaryColor: '#1b1b1e',
          tertiaryColor: '#161618',
        }
      });
      await mermaid.run();
    </script>
  )}
</Base>
